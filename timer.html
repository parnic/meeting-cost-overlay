<html>
    <head>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">
        <style>
            #setup {
                display: flex;
                justify-content: center;
            }
            #setup span {
                margin-right: 1em;
            }
            #setup input[type=number] {
                width: 4rem;
            }
            #timer {
                text-align: center;
                line-height: 1;
                margin-top: 0.2em;
            }
            .text-with-hour {
                font-size: 20vw;
            }
            .text-no-hour {
                font-size: 29vw;
            }
            #cost {
                font-size: 5vw;
                text-align: center;
            }
            body {
                font-family: 'Lato', sans-serif;
            }
            .in-time {
                background-color: #222;
                color: #eee;
            }
            .over-time {
                background-color: #ffd21f;
                color: #222;
            }
        </style>
    </head>
    <body class="in-time">
        <div id="setup">
            <span>
                <label for="in-numPeople"># people: </label>
                <input type="number" id="in-numPeople" value="20" maxlength="5" size="5"/>
            </span>
            <span>
                <label for="in-costPerHourPerPerson">$/hr/person: </label>
                <input type="number" id="in-costPerHourPerPerson" value="100" maxlength="4" size="4"/>
            </span>
            <span>
                <label for="in-sourceTime">Start time: </label>
                <input type="time" id="in-sourceTime" value="13:00"/>
            </span>
            <span>
                <label for="in-targetTime">End time: </label>
                <input type="time" id="in-targetTime" value="14:00"/>
            </span>
        </div>
        <div id="timer"></div>
        <div id="cost"></div>

        <script>
            let t = document.querySelector('#timer');
            let c = document.querySelector('#cost');
            let costPerHourPerPersonElem = document.querySelector('#in-costPerHourPerPerson');
            let numPeopleElem = document.querySelector('#in-numPeople');
            let sourceTimeElem = document.querySelector('#in-sourceTime');
            let targetTimeElem = document.querySelector('#in-targetTime');

            let msSinceLast = 0;
            let currentTotal = 0;
            let lastUpdateTime = new Date().getTime();

            sourceTimeElem.addEventListener('change', function(event) {
                currentTotal = 0;
            });

            let parseTimeFromElement = function(element) {
                let givenTimeValues = element.value.split(':');
                let givenHour = parseInt(givenTimeValues[0]);
                let givenMinute = parseInt(givenTimeValues[1]);

                return {givenHour: givenHour, givenMinute: givenMinute};
            }

            let hmsTimeDiff = function(durationMs) {
                let totalSec = durationMs / 1000;
                let secs = totalSec % 60;
                let totalMins = totalSec / 60;
                let mins = totalMins % 60;
                let totalHours = totalMins / 60;
                return {hours: Math.trunc(totalHours), mins: Math.trunc(mins), secs: Math.trunc(secs)};
            }

            let getDateFromTimeElement = function(now, element) {
                let {givenHour, givenMinute} = parseTimeFromElement(element);
                if (isNaN(givenHour) || isNaN(givenMinute)) {
                    return null;
                }

                return new Date(now.getFullYear(), now.getMonth(), now.getDate(), givenHour, givenMinute, 0, 0);
            }

            let updateTimer = function() {
                let now = new Date();
                let targetTime = getDateFromTimeElement(now, targetTimeElem);
                if (!targetTime) {
                    return;
                }

                let afterTime = now > targetTime;
                let remaining = targetTime - now;
                if (afterTime) {
                    document.body.className = 'over-time';
                    remaining = now - targetTime;
                } else {
                    document.body.className = 'in-time';
                }

                let {hours, mins, secs} = hmsTimeDiff(remaining);
                let str = afterTime ? '+' : '';
                if (hours > 0) {
                    str += `${hours}:${mins.toString().padStart(2, '0')}:`;
                    t.className = 'text-with-hour';
                } else {
                    str += `${mins}:`;
                    t.className = 'text-no-hour';
                }
                t.innerText = `${str}${secs.toString().padStart(2, '0')}`;
            }

            let updateCost = function() {
                // todo: $ should get zeroed out if the meeting time(s) change. or have some other mechanism for determining when to start it over again or stop incrementing it
                if (costPerHourPerPersonElem.value.length == 0 || numPeopleElem.value.length == 0) {
                    return;
                }

                let costPerHourPerPerson = parseFloat(costPerHourPerPersonElem.value);
                let numPeople = parseInt(numPeopleElem.value);
                if (!costPerHourPerPerson || !numPeople) {
                    return;
                }

                let now = new Date();
                let nowMs = now.getTime();
                let sourceTime = getDateFromTimeElement(now, sourceTimeElem);
                if (!sourceTime) {
                    return;
                }

                if (sourceTime < now) {
                    let costPerPersonPerMs = costPerHourPerPerson / 60 / 60 / 1000;
                    let msSinceLast = nowMs - lastUpdateTime;
                    let costPerPersonSinceLast = costPerPersonPerMs * msSinceLast;
                    let costSinceLast = costPerPersonSinceLast * numPeople;

                    currentTotal += costSinceLast;
                }

                c.innerText = currentTotal.toLocaleString('en-US', { 
                    style: 'currency', 
                    currency: 'USD' 
                });

                lastUpdateTime = nowMs;
            }

            updateTimer();
            updateCost();
            setInterval(updateTimer, 1000);
            setInterval(updateCost, 50);
        </script>
    </body>
</html>
