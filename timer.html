<html>
    <head>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">
        <style>
            #setup {
                display: flex;
                justify-content: center;
            }
            #setup span {
                margin-right: 1em;
            }
            #setup input[type=number] {
                width: 4rem;
            }
            #timer {
                text-align: center;
                line-height: 1;
                margin-top: 0.2em;
            }
            .text-with-hour {
                font-size: 20vw;
            }
            .text-no-hour {
                font-size: 29vw;
            }
            .smaller-text {
                font-size: 5vw;
            }
            #cost {
                text-align: center;
            }
            body {
                font-family: 'Lato', sans-serif;
                transition: all ease .5s;
            }
            .in-time {
                background-color: #222;
                color: #eee;
                fill: #eee;
                stroke: #111;
            }
            .over-time {
                background-color: #ffd21f;
                color: #222;
                fill: #222;
                stroke: #eee;
            }
            .svg-baseline-hanging {
                dominant-baseline: hanging;
            }
            .svg-timer {
                stroke-width: 1.3vh;
                paint-order: stroke fill;
                stroke-linecap: round;
                stroke-linejoin: round;
                text-anchor: middle;
            }
            .svg-cost {
                stroke-width: 1vh;
                paint-order: stroke fill;
                stroke-linecap: round;
                stroke-linejoin: round;
                text-anchor: middle;
            }
            .mt-2 {
                margin-top: 0.2em;
            }
        </style>
    </head>
    <body class="in-time">
        <div id="setup">
            <span>
                <label for="in-numPeople"># people: </label>
                <input type="number" id="in-numPeople" value="20" maxlength="5" size="5"/>
            </span>
            <span>
                <label for="in-costPerHourPerPerson">$/hr/person: </label>
                <input type="number" id="in-costPerHourPerPerson" value="100" maxlength="4" size="4"/>
            </span>
            <span>
                <label for="in-sourceTime">Start time: </label>
                <input type="time" id="in-sourceTime" value="13:00"/>
            </span>
            <span>
                <label for="in-targetTime">End time: </label>
                <input type="time" id="in-targetTime" value="14:00"/>
            </span>
        </div>
        <div class="text-with-hour svg-baseline-hanging mt-2">
            <svg width="100%" height="1em">
                <text id="timer" x="50%" y="0" class="svg-timer"></text>
            </svg>
        </div>
        <div class="smaller-text svg-baseline-hanging">
            <svg width="100%" height="3em">
                <text id="cost" x="50%" y="8" class="svg-cost"></text>
            </svg>
        </div>

        <script>
            const timerElem = document.querySelector('#timer');
            const costElem = document.querySelector('#cost');
            const costPerHourPerPersonElem = document.querySelector('#in-costPerHourPerPerson');
            const numPeopleElem = document.querySelector('#in-numPeople');
            const sourceTimeElem = document.querySelector('#in-sourceTime');
            const targetTimeElem = document.querySelector('#in-targetTime');

            let msSinceLast = 0;
            let currentTotal = 0;
            let lastUpdateTime = new Date().getTime();

            sourceTimeElem.addEventListener('change', function(event) {
                currentTotal = 0;
                localStorage.setItem('sourceTime', sourceTimeElem.value);
            });
            targetTimeElem.addEventListener('change', function(event) {
                localStorage.setItem('targetTime', targetTimeElem.value);
            });
            numPeopleElem.addEventListener('change', function(event) {
                localStorage.setItem('numPeople', numPeopleElem.value);
            });
            costPerHourPerPersonElem.addEventListener('change', function(event) {
                localStorage.setItem('costPerHourPerPerson', costPerHourPerPersonElem.value);
            });

            const parseTimeFromElement = function(element) {
                const givenTimeValues = element.value.split(':');
                const givenHour = parseInt(givenTimeValues[0]);
                const givenMinute = parseInt(givenTimeValues[1]);

                return {givenHour: givenHour, givenMinute: givenMinute};
            }

            const hmsTimeDiff = function(durationMs) {
                const totalSec = durationMs / 1000;
                const secs = totalSec % 60;
                const totalMins = totalSec / 60;
                const mins = totalMins % 60;
                const totalHours = totalMins / 60;
                return {hours: Math.trunc(totalHours), mins: Math.trunc(mins), secs: Math.trunc(secs)};
            }

            const getDateFromTimeElement = function(now, element) {
                const {givenHour, givenMinute} = parseTimeFromElement(element);
                if (isNaN(givenHour) || isNaN(givenMinute)) {
                    return null;
                }

                return new Date(now.getFullYear(), now.getMonth(), now.getDate(), givenHour, givenMinute, 0, 0);
            }

            const updateTimer = function() {
                const now = new Date();
                const targetTime = getDateFromTimeElement(now, targetTimeElem);
                if (!targetTime) {
                    return;
                }

                const afterTime = now > targetTime;
                let remaining = targetTime - now;
                if (afterTime) {
                    document.body.className = 'over-time';
                    remaining = now - targetTime;
                } else {
                    document.body.className = 'in-time';
                }

                const {hours, mins, secs} = hmsTimeDiff(remaining);
                let str = afterTime ? '+' : '';
                if (hours > 0) {
                    str += `${hours}:${mins.toString().padStart(2, '0')}:`;
                    timerElem.className = 'text-with-hour';
                } else {
                    str += `${mins}:`;
                    timerElem.className = 'text-no-hour';
                }
                timerElem.textContent = `${str}${secs.toString().padStart(2, '0')}`;
            }

            const updateCost = function() {
                if (costPerHourPerPersonElem.value.length == 0 || numPeopleElem.value.length == 0) {
                    return;
                }

                const costPerHourPerPerson = parseFloat(costPerHourPerPersonElem.value);
                const numPeople = parseInt(numPeopleElem.value);
                if (!costPerHourPerPerson || !numPeople) {
                    return;
                }

                const now = new Date();
                const nowMs = now.getTime();
                const sourceTime = getDateFromTimeElement(now, sourceTimeElem);
                if (!sourceTime) {
                    return;
                }

                if (sourceTime < now) {
                    const costPerPersonPerMs = costPerHourPerPerson / 60 / 60 / 1000;
                    const msSinceLast = nowMs - lastUpdateTime;
                    const costPerPersonSinceLast = costPerPersonPerMs * msSinceLast;
                    const costSinceLast = costPerPersonSinceLast * numPeople;

                    currentTotal += costSinceLast;
                }

                costElem.textContent = currentTotal.toLocaleString('en-US', { 
                    style: 'currency', 
                    currency: 'USD' 
                });

                lastUpdateTime = nowMs;
            }

            const applySavedValues = function() {
                const sourceTime = localStorage.getItem('sourceTime');
                const targetTime = localStorage.getItem('targetTime');
                const numPeople = localStorage.getItem('numPeople');
                const costPerHourPerPerson = localStorage.getItem('costPerHourPerPerson');

                if (sourceTime) {
                    sourceTimeElem.value = sourceTime;
                }
                if (targetTime) {
                    targetTimeElem.value = targetTime;
                }
                if (numPeople) {
                    numPeopleElem.value = numPeople;
                }
                if (costPerHourPerPerson) {
                    costPerHourPerPersonElem.value = costPerHourPerPerson;
                }
            }

            applySavedValues();
            updateTimer();
            updateCost();
            setInterval(updateTimer, 1000);
            setInterval(updateCost, 50);
        </script>
    </body>
</html>
